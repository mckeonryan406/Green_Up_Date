---
title: "R Notebook"
output:
  html_document:
    df_print: paged
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}

# IMPORT Libraries and Data... change date data format and plot the ndvi time series

library(data.table)
library(lubridate)
library(changepoint)
library(zoo)
library(gridExtra)
library(tidyverse)

# load MODIS NDVI data
ndviDF = fread("EasternPA_poly_ndvi_2000_2020.csv") 

# convert "Date" to date object AND put it in a new field called "rDate"
ndviDF$rDate = parse_date_time(ndviDF$Satellite_data, "%d-%m-%y")
#ndviDF$rJulianDay = yday(ndviDF$rDate)

# add year field by reading the date-time in "rDate" field
ndviDF$year = year(ndviDF$rDate)

# # Define Characteristic "Winter" and "Summer" values for NDVI
# # Find the lowest 20% and highest 80% values
# nVals = length(ndviDF$ndviMedian)  # get the number of values
# idxlow = round(0.20*nVals)           # find the index of the 20% from the bottom value
# idxhigh = round(0.80*nVals)           # find the index of the 80% from the bottom value
# ndviDF_sorted <- ndviDF[order(ndviDF$ndviMedian), ]  # sort the data frame by median values in ascending order
# winterThreshold = ndviDF_sorted$ndviMedian[idxlow]       # get the median value for the 5% threshold
# summerThreshold = ndviDF_sorted$ndviMedian[idxhigh]
# 
# print(winterThreshold)
# print(summerThreshold)

# Set the Winter Threshold manually... too inconsitent to do with a % from the full dataset
winterThreshold = 0.5
summerThreshold - 0.8


# Make Blue and Red Lines dynamic?  i.e. a proportion of the way through the dataset?  See below
# Plot the NDVI Time Series
ggplot(data=ndviDF) +
  geom_line(aes(x=ndviDF$rDate, y=ndviDF$ndviMedian)) +
  geom_hline(yintercept = winterThreshold, color = "blue") +          # draw a horizonal line on the plot
  geom_hline(yintercept = summerThreshold, color = "red") +
  xlab("Year") +
  ylab("Median NDVI Observed") +
  ggtitle("NDVI from MODIS Terra 8-day Global 500m Data Set")


# Histogram of all NDVI values observed
ggplot(data=ndviDF) +
  geom_histogram(aes(ndviMedian), binwidth = 0.03) +
  geom_vline(xintercept = winterThreshold, color = "blue") +
  geom_vline(xintercept = summerThreshold, color = "red") +
  xlab("Median NDVI Observed") +
  ylab("Count") +
  ggtitle("Distribution of All NDVI Values Observed")






```

```{r}
# Time Series Data Smoothing Using Loess Filter

# remove 2020 because it is incomplete
ndviDF = ndviDF[ndviDF$year<2020]

# Make a Facet Figure (Small Multiples) showing median NDVI for each year and Loess Smoothing
ggplot(data = ndviDF, aes(x=pixelJdateMode, y=ndviMedian)) +
  geom_point(aes(y=ndviMedian), color="black") +
  geom_smooth(method="loess", span=0.5) +
  geom_hline(yintercept = winterThreshold, color="green") +
  facet_wrap(~year)


```

```{r}
# Work with Data at Annual Scale... FIND Greatest Green UP acceleration
# First figure it out for a single year...  Later put it in a loop for all years

Year = 2017

# subset the input data to keep only rows from a single year and filter out NAs in ndvi
ndviYear <- ndviDF %>%
  filter(year == Year & is.na(ndviMedian) == FALSE)

# use Loess() to smooth data -- Here using a 50% Span factor
loess50 = loess(ndviMedian ~ pixelJdateMode, data = ndviYear, span = .5)
ndviYear$loess50 = predict(loess50)

# Find slope of loess smoothed fit to time series
ndviYear$slope = 0
for (i in 2:nrow(ndviYear)) {
  ndviYear[i,"slope"] = (ndviYear[i,"loess50"] - ndviYear[i-1,"loess50"])/(ndviYear[i,"pixelJdateMode"] - ndviYear[i-1,"pixelJdateMode"])
}

# find the highest positive slope value (i.e. greening up in spring) and store the Julian Date
maxSlope = max(ndviYear$slope)
maxSlopeJdate = ndviYear[ndviYear$slope == maxSlope,]$pixelJdateMode  

# Calc rate of change of slope (acceleration of greening) of loess smoothed fit
ndviYear$acceleration = 0
for (i in 3:nrow(ndviYear)) {
  ndviYear[i,"acceleration"] = (ndviYear[i,"slope"] - ndviYear[i-1,"slope"])/(ndviYear[i,"pixelJdateMode"] - ndviYear[i-1,"pixelJdateMode"])
}

# Find the highest acceleration prior to the highest slope

# Use slope and acceleration of greening to estimate the start of "Green Up"
# Here the "Start of Green Up" is defined as the highest acceleration prior to the steepest slope and a NDVI greater than the "winter threshold" AND slope is positive, i.e. it is greening up
AccelerationDF <- ndviYear %>%
  filter(pixelJdateMode < maxSlopeJdate & ndviMedian > winterThreshold & slope > 0)

maxSpringAcceleration = max(AccelerationDF$acceleration)
maxSpringAccJdate = ndviYear[ndviYear$acceleration == maxSpringAcceleration,]$pixelJdateMode  


# plot up the single year of data using the Julian Date of pixel data acquisition 
p1 = ggplot(data = ndviYear) +
  geom_point(mapping = aes(x=pixelJdateMode, y=ndviMedian),color = "black",, shape = 21, size = 2.5) +
  geom_line(mapping = aes(x=pixelJdateMode, y=loess50), color = "red", size = 1,) +
  geom_vline(xintercept = maxSpringAccJdate, color = "red") +
  xlab("") +
  ylab("Smoothed NDVI") +
  theme_light() 

p2 = ggplot(data = ndviYear) +
 
  geom_col(mapping = aes(x=pixelJdateMode, y=slope*100), color = "dark blue", size = 3, alpha = 0.6) +
  geom_vline(xintercept = maxSpringAccJdate, color = "red") +
  xlab("") +
  ylab("Slope") +
  theme_light()

p3 = ggplot(data = ndviYear) +
  geom_col(mapping = aes(x=pixelJdateMode, y=acceleration*1000), color = "dark red", size = 1.5, alpha = 0.8) +
  geom_vline(xintercept = maxSpringAccJdate, color = "red") +
  xlab("Julian Date") +
  ylab("Acceleration") +
  theme_light()

grid.arrange(p1,p2,p3, ncol = 1)
```




```{r}
# Put the whole thing Together!!  


# IMPORT Libraries and Data... change date data format and plot the ndvi time series

library(data.table)
library(lubridate)
library(changepoint)
library(zoo)
library(gridExtra)
library(tidyverse)

# load MODIS NDVI data
ndviDF = fread("EasternPA_poly_ndvi_2000_2020.csv") 

# convert "Date" to date object AND put it in a new field called "rDate"
ndviDF$rDate = parse_date_time(ndviDF$Satellite_data, "%d-%m-%y")
#ndviDF$rJulianDay = yday(ndviDF$rDate)

# add year field by reading the date-time in "rDate" field
ndviDF$year = year(ndviDF$rDate)

# add "Green UP Date" field to be filled later
ndviDF$greenDate = 0

# # Define Characteristic "Winter" and "Summer" values for NDVI
# # Find the lowest 20% and highest 80% values
# nVals = length(ndviDF$ndviMedian)  # get the number of values
# idxlow = round(0.20*nVals)           # find the index of the 20% from the bottom value
# idxhigh = round(0.80*nVals)           # find the index of the 80% from the bottom value
# ndviDF_sorted <- ndviDF[order(ndviDF$ndviMedian), ]  # sort the data frame by median values in ascending order
# winterThreshold = ndviDF_sorted$ndviMedian[idxlow]       # get the median value for the 5% threshold
# summerThreshold = ndviDF_sorted$ndviMedian[idxhigh]
# 
# print(winterThreshold)
# print(summerThreshold)

# Set the Winter Threshold manually... too inconsitent to do with a % from the full dataset
winterThreshold = 0.5
summerThreshold - 0.8


# Make Blue and Red Lines dynamic?  i.e. a proportion of the way through the dataset?  See below
# Plot the NDVI Time Series
ggplot(data=ndviDF) +
  geom_line(aes(x=ndviDF$rDate, y=ndviDF$ndviMedian)) +
  geom_hline(yintercept = winterThreshold, color = "blue") +          # draw a horizonal line on the plot
  geom_hline(yintercept = summerThreshold, color = "red") +
  xlab("Year") +
  ylab("Median NDVI Observed") +
  ggtitle("NDVI from MODIS Terra 8-day Global 500m Data Set")


# Histogram of all NDVI values observed
ggplot(data=ndviDF) +
  geom_histogram(aes(ndviMedian), binwidth = 0.03) +
  geom_vline(xintercept = winterThreshold, color = "blue") +
  geom_vline(xintercept = summerThreshold, color = "red") +
  xlab("Median NDVI Observed") +
  ylab("Count") +
  ggtitle("Distribution of All NDVI Values Observed")

# Time Series Data Smoothing Using Loess Filter

# remove 2020 because it is incomplete
ndviDF = ndviDF[ndviDF$year<2020]

# Make a Facet Figure (Small Multiples) showing median NDVI for each year and Loess Smoothing
ggplot(data = ndviDF, aes(x=pixelJdateMode, y=ndviMedian)) +
  geom_point(aes(y=ndviMedian), color="black") +
  geom_smooth(method="loess", span=0.5) +
  geom_hline(yintercept = winterThreshold, color="green") +
  facet_wrap(~year)

# Work with Data at Annual Scale... FIND Greatest Green UP acceleration
# Loop Through and aggregate.

greenUpDF = setNames(data.frame(matrix(ncol = 4, nrow = 20)), c("year", "greenUpJdate", "ndviMedian", "maxSlope"))

for (i in 2000:2019) {
  currentYear = i
  currentIDX = i-1999
  
  # subset the input data to keep only rows from a single year and filter out NAs in ndvi
  ndviYear <- ndviDF %>%
    filter(year == currentYear & is.na(ndviMedian) == FALSE)
  
  # use Loess() to smooth data -- Here using a 50% Span factor
  loess50 = loess(ndviMedian ~ pixelJdateMode, data = ndviYear, span = .5)
  ndviYear$loess50 = predict(loess50)
  
  # Find slope of loess smoothed fit to time series
  ndviYear$slope = 0
  for (i in 2:nrow(ndviYear)) {
    ndviYear[i,"slope"] = (ndviYear[i,"loess50"] - ndviYear[i-1,"loess50"])/(ndviYear[i,"pixelJdateMode"] - ndviYear[i-1,"pixelJdateMode"])
  }
  
  # find the highest positive slope value (i.e. greening up in spring) and store the Julian Date
  maxSlope = max(ndviYear$slope)
  maxSlopeJdate = ndviYear[ndviYear$slope == maxSlope,]$pixelJdateMode  
  
  # Calc rate of change of slope (acceleration of greening) of loess smoothed fit
  ndviYear$acceleration = 0
  for (i in 3:nrow(ndviYear)) {
    ndviYear[i,"acceleration"] = (ndviYear[i,"slope"] - ndviYear[i-1,"slope"])/(ndviYear[i,"pixelJdateMode"] - ndviYear[i-1,"pixelJdateMode"])
  }
  
  # Find the highest acceleration prior to the highest slope
  
  # Use slope and acceleration of greening to estimate the start of "Green Up"
  # Here the "Start of Green Up" is defined as the highest acceleration prior to the steepest slope and a NDVI greater than the "winter threshold" AND slope is positive (i.e. it is greening up)
  AccelerationDF <- ndviYear %>%
    filter(pixelJdateMode < maxSlopeJdate & ndviMedian > winterThreshold & slope > 0)
  
  maxSpringAcceleration = max(AccelerationDF$acceleration)
  maxSpringAccJdate = ndviYear[ndviYear$acceleration == maxSpringAcceleration,]$pixelJdateMode  
 
  greenUpDF[currentIDX,"year"] = currentYear
  greenUpDF[currentIDX,"greenUpJdate"] = maxSpringAccJdate
  greenUpDF[currentIDX,"ndviMedian"] = ndviYear[ndviYear$acceleration == maxSpringAcceleration,]$ndviMedian
  greenUpDF[currentIDX,"maxSlope"] = maxSlope
}
  
ggplot(greenUpDF) +
  geom_point(mapping = aes(x=year, y=greenUpJdate)) +
  xlab("Year") +
  ylab("Green Up Date (Julian)") +
  ggtitle("The Start of Spring Through the Years")
  



```

